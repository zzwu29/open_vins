<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OpenVINS: MSCKF Nullspace Projection</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">OpenVINS
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="update.html">Measurement Update Derivations</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">MSCKF Nullspace Projection </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In the standard EKF update, given a linearized measurement error (or residual) equation:</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{align*} \tilde{\mathbf{z}}_{m,k} &amp;\simeq \mathbf{H}_{x} \tilde{\mathbf{x}}_{k} + \mathbf{H}_{f} {}^G\tilde{\mathbf{p}}_f + \mathbf{n}_k \end{align*}" src="form_261.png"/>
</p>
<p>we naively need to compute the residual covariance matrix <img class="formulaInl" alt="$\mathbf{P}_{zz}$" src="form_262.png"/> as follows:</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{align*} \mathbf{P}_{zz} &amp;= \mathbb{E}\left[ \tilde{\mathbf{z}}_{m,k}{m,k} \tilde{\mathbf{z}}_{m,k}^\top \right] \\[5px] &amp;= \mathbb{E}\left[ (\mathbf{H}_{x}\tilde{\mathbf{x}}_{k}+\mathbf{H}_{f}{}^G\tilde{\mathbf{p}}_f+\mathbf{n}_k) (\mathbf{H}_{x}\tilde{\mathbf{x}}_{k}+\mathbf{H}_{f}{}^G\tilde{\mathbf{p}}_f+\mathbf{n}_k)^\top \right] \\[5px] &amp;= \mathbb{E}\Big[ \mathbf{H}_{x}\tilde{\mathbf{x}}_{k}\tilde{\mathbf{x}}_{k}^\top\mathbf{H}_{x}^\top +\mathbf{H}_{x}\tilde{\mathbf{x}}_{k}{}^G\tilde{\mathbf{p}}_f^\top\mathbf{H}_{f}^\top +\textcolor{red}{\mathbf{H}_{x}\tilde{\mathbf{x}}_{k}\mathbf{n}_k^\top} \nonumber\\[3px] &amp;\hspace{3cm}+ \mathbf{H}_{f}{}^G\tilde{\mathbf{p}}_f\tilde{\mathbf{x}}_{k}^\top\mathbf{H}_{x}^\top +\mathbf{H}_{f}{}^G\tilde{\mathbf{p}}_f{}^G\tilde{\mathbf{p}}_f^\top\mathbf{H}_{f}^\top +\mathbf{H}_{f}{}^G\tilde{\mathbf{p}}_f\mathbf{n}_k^\top \nonumber\\[3px] &amp;\hspace{3cm}+ \textcolor{red}{\mathbf{n}_k\tilde{\mathbf{x}}_{k}^\top\mathbf{H}_{x}^\top} +\mathbf{n}_k{}^G\tilde{\mathbf{p}}_f^\top\mathbf{H}_{f}^\top +\mathbf{n}_k\mathbf{n}_k^\top \Big] \\[5px] \empty &amp;= \mathbf{H}_x\mathbb{E}\Big[\tilde{\mathbf{x}}_{k}\tilde{\mathbf{x}}_{k}^\top\Big]\mathbf{H}_x^\top +\mathbf{H}_x\mathbb{E}\Big[\tilde{\mathbf{x}}_{k}{}^G\tilde{\mathbf{p}}_f^\top\Big]\mathbf{H}_f^\top +\mathbf{H}_f\mathbb{E}\Big[{}^G\tilde{\mathbf{p}}_f\tilde{\mathbf{x}}_{k}^\top\Big]\mathbf{H}_x^\top + \mathbf{H}_f\mathbb{E}\Big[{}^G\tilde{\mathbf{p}}_f{}^G\tilde{\mathbf{p}}_f^\top\Big]\mathbf{H}_f^\top \nonumber\\[3px] &amp;\hspace{3.2cm}+ \mathbf{H}_f\mathbb{E}\Big[{}^G\tilde{\mathbf{p}}_f\mathbf{n}_k^\top\Big] +\mathbb{E}\Big[\mathbf{n}_k{}^G\tilde{\mathbf{p}}_f^\top\Big]\mathbf{H}_f^\top +\mathbb{E}\Big[\mathbf{n}_k\mathbf{n}_k^\top\Big] \\[5px] \empty &amp;= \mathbf{H}_x \mathbf{P}_{xx}\mathbf{H}_x^\top +\mathbf{H}_x \mathbf{P}_{xf}\mathbf{H}_f^\top +\mathbf{H}_f \mathbf{P}_{fx}\mathbf{H}_x^\top + \mathbf{H}_f \mathbf{P}_{ff}\mathbf{H}_f^\top \nonumber\\[3px] &amp;\hspace{2.3cm}+ \mathbf{H}_f \mathbf{P}_{fn} +\mathbf{P}_{nf} \mathbf{H}_f^\top +\mathbf{R}_d \end{align*}" src="form_263.png"/>
</p>
<p>However, there would be a big problem in visual-inertial odometry (VIO); that is, we do not know what the prior feature covariance and it is coupled with both the state, itself, and the noise (i.e., <img class="formulaInl" alt="$\mathbf{P}_{xf}$" src="form_264.png"/>, <img class="formulaInl" alt="$\mathbf{P}_{ff}$" src="form_265.png"/>, and <img class="formulaInl" alt="$\mathbf{P}_{nf}$" src="form_266.png"/>). This motivates the need for a method to remove the feature <img class="formulaInl" alt="${}^G\tilde{\mathbf{p}}_f$" src="form_267.png"/> from the linearized measurement equation (thus removing the correlation between the measurement and its error).</p>
<p>To this end, we start with the measurement residual function by removing the "sensitivity" to feature error we compute and apply the left nullspace of the Jacobian <img class="formulaInl" alt="$\mathbf{H}_{f}$" src="form_268.png"/>. We can compute it using QR decomposition as follows:</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{align*} \mathbf{H}_{f} = \begin{bmatrix} \mathbf{Q_1} &amp; \mathbf{Q_2} \end{bmatrix} \begin{bmatrix} \mathbf{R_1} \\ \mathbf{0} \end{bmatrix} = \mathbf{Q_1}\mathbf{R_1} \end{align*}" src="form_269.png"/>
</p>
<p>Multiplying the linearized measurement equation by the nullspace of the feature Jacobian from the left yields:</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{align*} \tilde{\mathbf{z}}_{m,k} &amp;\simeq \mathbf{H}_{x} \tilde{\mathbf{x}}_{k} + \mathbf{Q_1}\mathbf{R_1}{}^G\tilde{\mathbf{p}}_f + \mathbf{n}_k \\[5px] \empty \Rightarrow~ \mathbf{Q_2}^\top\tilde{\mathbf{z}}_m &amp;\simeq \mathbf{Q_2}^\top\mathbf{H}_{x} \tilde{\mathbf{x}}_{k} + \textcolor{red}{\mathbf{Q_2}^\top\mathbf{Q_1}\mathbf{R_1} {}^G\tilde{\mathbf{p}}_f} + \mathbf{Q_2}^\top\mathbf{n}_k \\[5px] \empty \Rightarrow~ \mathbf{Q_2}^\top\tilde{\mathbf{z}}_m &amp;\simeq \mathbf{Q_2}^\top\mathbf{H}_{x} \tilde{\mathbf{x}}_{k} + \mathbf{Q_2}^\top\mathbf{n}_k \\[5px] \empty \Rightarrow~ \tilde{\mathbf{z}}_{o,k} &amp;\simeq \mathbf{H}_{o,k}\tilde{\mathbf{x}}_{k} + \mathbf{n}_{o,k} \end{align*}" src="form_270.png"/>
</p>
<p>where we have employed the fact that <img class="formulaInl" alt="$\mathbf Q_1$" src="form_271.png"/> and <img class="formulaInl" alt="$\mathbf Q_2$" src="form_272.png"/> are orthonormal.</p>
<p>We now examine the dimensions of the involved matrices to appreciate the computation saving gained from this nullspace projection.</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{align*} \textrm{size}(\mathbf{H}_{f}) &amp;= 2n\times3 \textrm{~~where~}n\textrm{~is the number of uv measurements of this feature} \\[5px] \textrm{size}({}^G\tilde{\mathbf{p}}_f) &amp;= 3\times1 \\[5px] \textrm{size}(\mathbf{H}_{x}) &amp;= 2n\times15+6c \textrm{~~where~}c\textrm{~is the number of clones} \\[5px] \textrm{size}(\tilde{\mathbf{x}}_{k}) &amp;= 15+6c\times1 \textrm{~~where~}c\textrm{~is the number of clones} \\[5px] \textrm{rank}(\mathbf{H}_{f}) &amp;\leq \textrm{min}(2n,3) = 3 \textrm{~~where equality holds in most cases} \\[5px] \textrm{nullity}(\mathbf{H}_{f}) &amp;= \textrm{size}(\mathbf{x}) - \textrm{rank}(\mathbf{H}_{f}) = 2n-3 \textrm{~~assuming full rank} \end{align*}" src="form_273.png"/>
</p>
<p>With that, we can have the following conclusion about the sizes when the nullspace is applied:</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{align*} \mathbf{Q_2}^\top\tilde{\mathbf{z}}_{m,k} &amp;\simeq \mathbf{Q_2}^\top\mathbf{H}_{x} \tilde{\mathbf{x}}_{k} + \mathbf{Q_2}^\top\mathbf{n}_k \\[5px] \empty \Rightarrow~ (2n-3\times2n)(2n\times1) &amp;= (2n-3\times2n)(2n\times15+6c)(15+6c\times1) \\ &amp;\hspace{3.5cm}+ (2n-3\times2n)(2n\times1) \nonumber\\[5px] \empty \tilde{\mathbf{z}}_{o,k} &amp;\simeq \mathbf{H}_{o,k}\tilde{\mathbf{x}}_{k} + \mathbf{n}_o \\[5px] \empty \Rightarrow~ (2n-3\times1) &amp;= (2n-3\times15+6c)(15+6c\times1) + (2n-3\times1) \end{align*}" src="form_274.png"/>
</p>
<p>Finally, we perform the EKF update using the inferred measurement <img class="formulaInl" alt="$\mathbf z_{o,k}$" src="form_275.png"/>:</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{align*} \hat{\mathbf{x}}_{k|k} &amp;= \hat{\mathbf{x}}_{k|k-1} + \mathbf{P}_{k|k-1} \mathbf{H}_{o,k}^\top (\mathbf{H}_{o,k} \mathbf{P}_{k|k-1} \mathbf{H}_{o,k}^\top + \mathbf{R}_o)^{-1}\tilde{\mathbf{z}}_{o,k} \\[5px] \mathbf{P}_{k|k} &amp;= \mathbf{P}_{k|k-1} - \mathbf{P}_{k|k-1}\mathbf{H}_{o,k}^\top (\mathbf{H}_{o,k} \mathbf{P}_{k|k-1} \mathbf{H}_{o,k}^\top + \mathbf{R}_o)^{-1} \mathbf{H}_{o,k}\mathbf{P}_{k|k-1}^\top \end{align*}" src="form_276.png"/>
</p>
<p>where the time index (subscript) <img class="formulaInl" alt="$k|k-1$" src="form_277.png"/> refers to the prior estimate which was denoted before by symbol <img class="formulaInl" alt="$\ominus$" src="form_278.png"/> and <img class="formulaInl" alt="$k|k$" src="form_279.png"/> corresponds to the posterior (or updated) estimate indicated before by <img class="formulaInl" alt="$\oplus$" src="form_280.png"/>.</p>
<h1><a class="anchor" id="implementation"></a>
Implementation</h1>
<p>Using Eigen 3 library, we perform QR decomposition to get the nullspace. Here we know that the size of <img class="formulaInl" alt="$\mathbf{Q}_1$" src="form_281.png"/> is <img class="formulaInl" alt="$2n\times3$" src="form_282.png"/>, which corresponds to the number of observations and size of the 3D point feature state.</p>
<div class="fragment"><div class="line">Eigen::ColPivHouseholderQR&lt;Eigen::MatrixXd&gt; qr(H_f.rows(), H_f.cols());</div><div class="line">qr.compute(H_f);</div><div class="line">Eigen::MatrixXd Q = qr.householderQ();</div><div class="line">Eigen::MatrixXd Q1 = Q.block(0,0,Q.rows(),3);</div><div class="line">Eigen::MatrixXd Q2 = Q.block(0,3,Q.rows(),Q.cols()-3);</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
